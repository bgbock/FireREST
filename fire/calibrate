#! /bin/bash

echo
echo "COMMAND	: $0 $@ # FireREST/FireFUSE visual calibration utility"

function help() {
  echo "SYNOPSIS: fire/calibrate [-h]"
  echo "EXAMPLE	: Generate position offsets"
  echo "	:   fire/calibrate -o"
  echo "EXAMPLE	: Print this documentation:"
  echo "	:   fire/calibrate -h"
}

if [ "$1" == "" ] || [ "$1" == "-h" ]; then help; exit 0; fi

GCODEFIRE=/dev/firefuse/cnc/marlin/gcode.fire
if [ ! -e $GCODEFIRE ]; then
  echo "ERROR	: FireFUSE serial connection to Marlin is unavailable"
  echo "TRY	: See /var/log/firefuse.log for details"
  exit -1
fi

function gcode() {
  if [ "$2" != "" ]; then echo "STATUS	: $2"; fi
  echo "GCODE	: $1"
  echo "$1" > $GCODEFIRE
  RC=$?; if [ $RC -ne 0 ]; then echo "ERROR	: $RC"; exit -1; fi
}

function camera() {
  echo "COMMAND : cp /dev/firefuse/sync/cv/1/camera.jpg /var/firefuse/calibration/$1"
  cp /dev/firefuse/sync/cv/1/camera.jpg /var/firefuse/calibration/$1
  RC=$?; if [ $RC -ne 0 ]; then echo "ERROR	: $RC"; exit -1; fi
}

if [ "$1" == "-o" ]; then
  gcode G28Z0 "Homing"
  gcode G0X0Y0Z0 "Move to origin"
  camera camx0y0z0.jpg
  gcode G0X1Y1Z0 "Move to origin"
  camera camx1y1z0.jpg

  echo "STATUS	: changed default configuration file"
  echo "SUCCESS	: "`ls -l config-default.json | grep -o config.*json`
  exit 0;
fi
